{"id":789,"date":"2019-01-31T23:26:30","date_gmt":"2019-01-31T23:26:30","guid":{"rendered":"http:\/\/reproducibility.stanford.edu\/?p=789"},"modified":"2024-12-04T18:37:40","modified_gmt":"2024-12-04T18:37:40","slug":"fmriprep-tutorial-running-the-docker-image","status":"publish","type":"post","link":"https:\/\/reproducibility.stanford.edu\/fmriprep-tutorial-running-the-docker-image\/","title":{"rendered":"fMRIPrep tutorial: Running the docker image"},"content":{"rendered":"<p><strong>Introduction<\/strong><\/p>\n<p><span style=\"font-weight: 400;\">Welcome to our tutorial on running <\/span><a href=\"https:\/\/fmriprep.readthedocs.io\/en\/stable\/\"><span style=\"font-weight: 400;\">fMRIPrep<\/span><\/a><span style=\"font-weight: 400;\"> (for a more detailed description of the tool, please check out our <\/span><a href=\"https:\/\/doi.org\/10.1038\/s41592-018-0235-4\"><span style=\"font-weight: 400;\">recent paper<\/span><\/a><span style=\"font-weight: 400;\">\/<\/span><a href=\"https:\/\/doi.org\/10.1101\/306951\"><span style=\"font-weight: 400;\">preprint<\/span><\/a><span style=\"font-weight: 400;\">). In this tutorial, we will be utilizing the <\/span><a href=\"https:\/\/fmriprep.readthedocs.io\/en\/stable\/installation.html#docker-container\"><span style=\"font-weight: 400;\">docker container of fMRIPrep<\/span><\/a><span style=\"font-weight: 400;\">. This tutorial will illustrate a detailed step-by-step guide on how to prepare and run this. We will provide the command line inputs to do this. The guide will be using data prepared and BIDS validated from a <\/span><a href=\"http:\/\/reproducibility.stanford.edu\/bids-tutorial-series-part-1a\/\"><span style=\"font-weight: 400;\">previous tutorial<\/span><\/a><span style=\"font-weight: 400;\">.<\/span><\/p>\n<p>Table of contents<\/p>\n<ol>\n<li style=\"font-weight: 400;\"><span style=\"font-weight: 400;\"><a href=\"#fmriprep1\">Setting up your environment<\/a><\/span><\/li>\n<li style=\"font-weight: 400;\"><span style=\"font-weight: 400;\"><a href=\"#fmriprep2\">FreeSurfer License<\/a><\/span><\/li>\n<li style=\"font-weight: 400;\"><span style=\"font-weight: 400;\"><a href=\"#fmriprep3\">Running fMRIPrep<\/a><\/span><\/li>\n<li style=\"font-weight: 400;\"><span style=\"font-weight: 400;\"><a href=\"#fmriprep4\">fMRIPrep outputs and the visual reports<\/a><\/span><\/li>\n<li style=\"font-weight: 400;\"><span style=\"font-weight: 400;\"><a href=\"#fmriprep5\">Troubleshooting<\/a><\/span><\/li>\n<\/ol>\n<p>&nbsp;<\/p>\n<p><strong>Guide to running fMRIPrep<\/strong><\/p>\n<p><b><a id=\"fmriprep1\"><\/a>Step 1.<\/b><span style=\"font-weight: 400;\"> To begin, we first need to initialize the environment. We will be utilizing <\/span><a href=\"https:\/\/www.docker.com\/get-started\"><span style=\"font-weight: 400;\">Docker<\/span><\/a><span style=\"font-weight: 400;\"> for running fMRIPrep. In addition, please download <\/span><a href=\"https:\/\/www.python.org\/downloads\/\"><span style=\"font-weight: 400;\">Python<\/span><\/a><span style=\"font-weight: 400;\">. After you have gotten Docker and Python, we can use the command line to download a wrapper to run fMRIPrep. The command is shown below.<\/span><\/p>\n<div style=\"background: #ffffff; overflow: auto; width: auto; border: solid gray; border-width: .1em .1em .1em .8em; padding: .2em .6em;\">\n<pre style=\"margin: 0; line-height: 125%;\">pip install --user --upgrade fmriprep-docker<\/pre>\n<\/div>\n<p>&nbsp;<\/p>\n<p><span style=\"font-weight: 400;\">For this tutorial, we will be using the <\/span><a href=\"http:\/\/fcon_1000.projects.nitrc.org\/indi\/pro\/eNKI_RS_TRT\/FrontPage.html\"><span style=\"font-weight: 400;\">Nathan Kline Institute (NKI) Rockland Sample &#8211; Multiband Imaging Test-Retest Pilot Dataset<\/span><\/a><span style=\"font-weight: 400;\">. We will only be taking sub-2475376 session 1 anatomical and resting state scan at TR=1400ms. Please find pictured below our BIDS validated dataset.<\/span><\/p>\n<p style=\"text-align: center;\"><a href=\"http:\/\/reproducibility.stanford.edu\/wp-content\/uploads\/2019\/01\/fMRIPrep_NKIset.png\"><img loading=\"lazy\" decoding=\"async\" class=\"size-full wp-image-790 aligncenter\" src=\"http:\/\/reproducibility.stanford.edu\/wp-content\/uploads\/2019\/01\/fMRIPrep_NKIset.png\" alt=\"fMRIPrep_NKIset\" width=\"594\" height=\"263\" \/><\/a><\/p>\n<p>&nbsp;<\/p>\n<p><b>NOTE:<\/b><span style=\"font-weight: 400;\"> Please observe there are a few <\/span><a href=\"http:\/\/bids-standard.github.io\/bids-validator\/\"><span style=\"font-weight: 400;\">BIDS validator<\/span><\/a><span style=\"font-weight: 400;\"> warnings that may need to be attended to before running fMRIPrep. <\/span><\/p>\n<p><span style=\"font-weight: 400;\">1) To do the susceptibility distortion correction, the <\/span><a href=\"https:\/\/bids-specification.readthedocs.io\/en\/latest\/04-modality-specific-files\/01-magnetic-resonance-imaging-data.html#fieldmap-data\"><span style=\"font-weight: 400;\">IntendedFor<\/span><span style=\"font-weight: 400;\"> metadata keys<\/span><\/a><span style=\"font-weight: 400;\"> need to be defined for every field map that is to be applied.<\/span><\/p>\n<p><span style=\"font-weight: 400;\">2) To do the slice timing correction, the slice timings need to be defined in the <\/span><a href=\"https:\/\/bids-specification.readthedocs.io\/en\/latest\/04-modality-specific-files\/01-magnetic-resonance-imaging-data.html#fmri-task-information\"><span style=\"font-weight: 400;\">BOLD json metadata file<\/span><\/a><span style=\"font-weight: 400;\"> (if you want to ignore the slice timing correction, please add the <\/span><a href=\"https:\/\/fmriprep.readthedocs.io\/en\/stable\/usage.html?highlight=ignore%20slicetiming\"><span style=\"font-weight: 400;\">\u2010\u2010ignore slicetiming<\/span><\/a><span style=\"font-weight: 400;\"> option, the command to do this is shown <\/span><a href=\"#fmriprep_slicetiming\"><span style=\"font-weight: 400;\">below<\/span><\/a><span style=\"font-weight: 400;\">.) <\/span><\/p>\n<p><span style=\"font-weight: 400;\">3) Please be cautious running multiple subjects in parallel due to space and memory limits on your machine.<\/span><\/p>\n<p>&nbsp;<\/p>\n<p><b><a id=\"fmriprep2\"><\/a>Step 2. <\/b><span style=\"font-weight: 400;\">fMRIPrep uses FreeSurfer to reconstruct anatomical surfaces of the brain as well as some registration steps. Because of this, fMRIPrep requires a FreeSurfer license. To get the license and run FreeSurfer, FreeSurfer requires users to register for free, <\/span><a href=\"https:\/\/surfer.nmr.mgh.harvard.edu\/registration.html\"><span style=\"font-weight: 400;\">here<\/span><\/a><span style=\"font-weight: 400;\">. After filling out the registration form, a license file will be sent to the email provided. Please save this license file to your computer. We saved our license into a file called <em>\/Users\/franklinfeingold\/freesurfer.txt<\/em><\/span><span style=\"font-weight: 400;\">.<\/span><span style=\"font-weight: 400;\"> More information regarding this can be found <\/span><a href=\"https:\/\/fmriprep.readthedocs.io\/en\/stable\/installation.html#the-freesurfer-license\"><span style=\"font-weight: 400;\">here<\/span><\/a><span style=\"font-weight: 400;\">.<\/span><\/p>\n<p>&nbsp;<\/p>\n<p><b><a id=\"fmriprep3\"><\/a>Step 3.<\/b><span style=\"font-weight: 400;\"> Now we can call fmriprep-docker. The command to execute it is illustrated below. To break down the command: the first argument is providing the input path to the BIDS dataset. The next part is providing the output directory. Followed by passing the keyword \u2018participant\u2019 as the third argument, which selects the analysis level that will be executed (see the <\/span><a href=\"https:\/\/journals.plos.org\/ploscompbiol\/article?id=10.1371\/journal.pcbi.1005209\"><span style=\"font-weight: 400;\">BIDS-Apps specification<\/span><\/a><span style=\"font-weight: 400;\"> for further details and possible values; in the case of fMRIPrep, only &#8216;participant&#8217; is available). Lastly, we provide the participant label tag to indicate which participant to run. Please note that the \u2018sub-\u2019 prefix is not included. You may pass <\/span><a href=\"https:\/\/fmriprep.readthedocs.io\/en\/stable\/usage.html#command-line-arguments\"><span style=\"font-weight: 400;\">additional arguments<\/span><\/a><span style=\"font-weight: 400;\"> as you would to fMRIPrep. For simplicity, we <\/span><a href=\"https:\/\/fmriprep.readthedocs.io\/en\/stable\/installation.html#docker-container\"><span style=\"font-weight: 400;\">recommend<\/span><\/a><span style=\"font-weight: 400;\"> placing the input, output and analysis levels prior to any options.<\/span><\/p>\n<div style=\"background: #ffffff; overflow: auto; width: auto; border: solid gray; border-width: .1em .1em .1em .8em; padding: .2em .6em;\">\n<pre style=\"margin: 0; line-height: 125%;\">fmriprep-docker \/Users\/franklinfeingold\/Desktop\/BIDS_NKI_walkthrough\/Nifti \/Users\/franklinfeingold\/Desktop\/BIDS_NKI_walkthrough\/derivatives participant --participant-label 2475376 --fs-license-file \/Users\/franklinfeingold\/freesurfer.txt<\/pre>\n<\/div>\n<p><span style=\"font-weight: 400;\">Running this command may download the latest docker image of fMRIPrep if you don\u2019t have it installed already. This installation will take time and the screen may not update often, but the process is running. We are also checking for memory constraints and you may need to <\/span><a href=\"#fmriprep_memory\"><span style=\"font-weight: 400;\">increase your docker memory<\/span><\/a><span style=\"font-weight: 400;\">. In the command line it will output a \u201cRUNNING: \u201c line. This is showing the docker command that is actually constructed and ran. If the fmriprep-docker &#8220;command not found&#8221;\u00a0<a href=\"https:\/\/neurostars.org\/t\/fmriprep-docker-command\/4105\/7\">this response<\/a> will be helpful to solve this issue.<\/span><\/p>\n<p><span style=\"font-weight: 400;\">fMRIPrep is now running on your data! <\/span><\/p>\n<p><span style=\"font-weight: 400;\"><a id=\"fmriprep_slicetiming\"><\/a>If you would like to add additional options to the call, this is the step to do this. For example, if you would like to ignore the slice timing correction. The call is shown below. <\/span><\/p>\n<div style=\"background: #ffffff; overflow: auto; width: auto; border: solid gray; border-width: .1em .1em .1em .8em; padding: .2em .6em;\">\n<pre style=\"margin: 0; line-height: 125%;\">fmriprep-docker \/Users\/franklinfeingold\/Desktop\/BIDS_NKI_walkthrough\/Nifti \/Users\/franklinfeingold\/Desktop\/BIDS_NKI_walkthrough\/derivatives participant --participant-label 2475376 --fs-license-file \/Users\/franklinfeingold\/freesurfer.txt --ignore slicetiming<\/pre>\n<\/div>\n<p>&nbsp;<\/p>\n<p><b><a id=\"fmriprep4\"><\/a>Step 4.<\/b><span style=\"font-weight: 400;\"> When fMRIPrep has completed running, the output directory looks like this.<\/span><\/p>\n<p><a href=\"http:\/\/reproducibility.stanford.edu\/wp-content\/uploads\/2019\/01\/fmriprep_1.png\"><img loading=\"lazy\" decoding=\"async\" class=\" wp-image-791 aligncenter\" src=\"http:\/\/reproducibility.stanford.edu\/wp-content\/uploads\/2019\/01\/fmriprep_1.png\" alt=\"fmriprep_output1\" width=\"632\" height=\"484\" \/><\/a><a href=\"http:\/\/reproducibility.stanford.edu\/wp-content\/uploads\/2019\/01\/fmriprep_2.png\"><img loading=\"lazy\" decoding=\"async\" class=\" wp-image-792 aligncenter\" src=\"http:\/\/reproducibility.stanford.edu\/wp-content\/uploads\/2019\/01\/fmriprep_2.png\" alt=\"fmriprep_output2\" width=\"632\" height=\"435\" \/><\/a><a href=\"http:\/\/reproducibility.stanford.edu\/wp-content\/uploads\/2019\/01\/fmriprep_3.png\"><img loading=\"lazy\" decoding=\"async\" class=\"wp-image-793 aligncenter\" src=\"http:\/\/reproducibility.stanford.edu\/wp-content\/uploads\/2019\/01\/fmriprep_3.png\" alt=\"fmriprep_output3\" width=\"632\" height=\"47\" \/><\/a><\/p>\n<p><span style=\"font-weight: 400;\">A detailed description of the fMRIPrep outputs can be found <\/span><a href=\"https:\/\/fmriprep.readthedocs.io\/en\/stable\/outputs.html\"><span style=\"font-weight: 400;\">here<\/span><\/a><span style=\"font-weight: 400;\">. More broadly, the outputs of fMRIPrep conform to the <\/span><a href=\"https:\/\/docs.google.com\/document\/d\/17ebopupQxuRwp7U7TFvS6BH03ALJOgGHufxK8ToAvyI\/edit\"><span style=\"font-weight: 400;\">BIDS-Derivatives specification, Release Candidate 1<\/span><\/a><span style=\"font-weight: 400;\">.<\/span><\/p>\n<p><span style=\"font-weight: 400;\"><strong>NOTE:<\/strong>\u00a0fMRIPrep does <strong>not<\/strong> run confounds regression or any other filtering. We do provide a <\/span><a href=\"https:\/\/fmriprep.readthedocs.io\/en\/stable\/outputs.html#confounds\"><span style=\"font-weight: 400;\">confounds .tsv file<\/span><\/a><span style=\"font-weight: 400;\"> with one confounding time-series per column, from which you can select and use after pertinent orthogonalizations to regress confounds out with their preferred tools. <\/span><\/p>\n<p>&nbsp;<\/p>\n<p><b>Now we have completed running fMRIPrep on the dataset! What&#8217;s Next? <\/b><span style=\"font-weight: 400;\">After running fMRIPrep we encourage you to open up the generated visual reports (for example, screenshots of the <\/span><a href=\"#fmriprep_output1\"><span style=\"font-weight: 400;\">Brain mask and brain tissue segmentation of the T1w<\/span><\/a><span style=\"font-weight: 400;\">, <\/span><a href=\"#fmriprep_output2\"><span style=\"font-weight: 400;\">EPI to T1 registration<\/span><\/a><span style=\"font-weight: 400;\">, and the <\/span><a href=\"#fmriprep_output3\"><span style=\"font-weight: 400;\">BOLD Summary<\/span><\/a><span style=\"font-weight: 400;\"> portions are shown below). These reports, written in HTML to be viewed in your web browser (we recommend Chrome or Firefox), will walk you through the preprocessing steps run, and highlights some of the decisions fMRIPrep made along the way. A careful examination of the report of every subject should be done to assess the quality of the preprocessing results. Under the &#8220;Methods&#8221; section of each report, you&#8217;ll find a detailed description of the exact processing workflow ready to copy-and-paste into your manuscript, including all pertinent references.<\/span><\/p>\n<p>&nbsp;<\/p>\n<p><a id=\"fmriprep_output1\"><\/a><b>Brain mask and brain tissue segmentation of the T1w<\/b><\/p>\n<p><a href=\"http:\/\/reproducibility.stanford.edu\/wp-content\/uploads\/2019\/01\/Brain_mask_and_brain_tissue_segmentation_of_the_T1w.png\"><img loading=\"lazy\" decoding=\"async\" class=\"alignnone size-full wp-image-794\" src=\"http:\/\/reproducibility.stanford.edu\/wp-content\/uploads\/2019\/01\/Brain_mask_and_brain_tissue_segmentation_of_the_T1w.png\" alt=\"Brain_mask_and_brain_tissue_segmentation_of_the_T1w\" width=\"1999\" height=\"1008\" \/><\/a><\/p>\n<p>&nbsp;<\/p>\n<p><strong><a id=\"fmriprep_output2\"><\/a>EPI to T1 Registration<\/strong><\/p>\n<p><a href=\"http:\/\/reproducibility.stanford.edu\/wp-content\/uploads\/2019\/01\/EPI_to_T1_registration.png\"><img loading=\"lazy\" decoding=\"async\" class=\"alignnone size-full wp-image-795\" src=\"http:\/\/reproducibility.stanford.edu\/wp-content\/uploads\/2019\/01\/EPI_to_T1_registration.png\" alt=\"EPI_to_T1_registration\" width=\"1999\" height=\"1048\" \/><\/a><\/p>\n<p>&nbsp;<\/p>\n<p><strong><a id=\"fmriprep_output3\"><\/a>BOLD Summary<\/strong><\/p>\n<p><a href=\"http:\/\/reproducibility.stanford.edu\/wp-content\/uploads\/2019\/01\/BOLD_summary.png\"><img loading=\"lazy\" decoding=\"async\" class=\"alignnone size-full wp-image-796\" src=\"http:\/\/reproducibility.stanford.edu\/wp-content\/uploads\/2019\/01\/BOLD_summary.png\" alt=\"BOLD_summary\" width=\"1999\" height=\"822\" \/><\/a><a href=\"http:\/\/reproducibility.stanford.edu\/wp-content\/uploads\/2019\/01\/BOLD_summary2.png\"><img loading=\"lazy\" decoding=\"async\" class=\"alignnone size-full wp-image-797\" src=\"http:\/\/reproducibility.stanford.edu\/wp-content\/uploads\/2019\/01\/BOLD_summary2.png\" alt=\"BOLD_summary2\" width=\"1999\" height=\"1016\" \/><\/a><\/p>\n<p>&nbsp;<\/p>\n<p><b><a id=\"fmriprep5\"><\/a>Step 5. <\/b><span style=\"font-weight: 400;\">New users may run into two families of problems:<\/span><\/p>\n<ul>\n<li><span style=\"font-weight: 400;\"><a id=\"fmriprep_memory\"><\/a>Memory issues: on <\/span><a href=\"https:\/\/docs.docker.com\/docker-for-windows\/#advanced\"><span style=\"font-weight: 400;\">Windows<\/span><\/a><span style=\"font-weight: 400;\"> and <\/span><a href=\"https:\/\/docs.docker.com\/docker-for-mac\/#advanced\"><span style=\"font-weight: 400;\">Mac OSX<\/span><\/a><span style=\"font-weight: 400;\"> systems, the Docker Engine is configured to access 2GB RAM by default. Please, check your Docker configuration before running fMRIPrep. We recommend assigning 8GB or more memory to the Docker Engine. Please make sure to apply &amp; restart or this change will not have been implemented. To check\/change this we have shown the process below.<\/span><\/li>\n<\/ul>\n<p style=\"text-align: center;\"><a href=\"http:\/\/reproducibility.stanford.edu\/wp-content\/uploads\/2019\/01\/docker_preferences.png\"><img loading=\"lazy\" decoding=\"async\" class=\"wp-image-798 aligncenter\" src=\"http:\/\/reproducibility.stanford.edu\/wp-content\/uploads\/2019\/01\/docker_preferences.png\" alt=\"docker_preferences\" width=\"213\" height=\"301\" \/><\/a><\/p>\n<p style=\"text-align: center;\"><a href=\"http:\/\/reproducibility.stanford.edu\/wp-content\/uploads\/2019\/01\/docker_preferences_advanced_arrows.png\"><img loading=\"lazy\" decoding=\"async\" class=\"wp-image-799 aligncenter\" src=\"http:\/\/reproducibility.stanford.edu\/wp-content\/uploads\/2019\/01\/docker_preferences_advanced_arrows.png\" alt=\"docker_preferences_advanced_arrows\" width=\"286\" height=\"255\" \/><\/a><\/p>\n<ul>\n<li style=\"font-weight: 400;\"><span style=\"font-weight: 400;\">Mounting drives on Windows: the Docker for Windows Engine does not allow sharing data from the host to make it available within the container. fMRIPrep requires that the original data are &#8220;mounted&#8221; into the container. Please make sure you allow Docker to mount folders <\/span><a href=\"https:\/\/docs.docker.com\/docker-for-windows\/#shared-drives\"><span style=\"font-weight: 400;\">from the host in your settings<\/span><\/a><span style=\"font-weight: 400;\">.<\/span><\/li>\n<li style=\"font-weight: 400;\"><span style=\"font-weight: 400;\">fMRIPrep requests the FreeSurfer license file, although one is provided. If you are on Windows, you may experience this problem for the same reason immediately above. Please check your drive-sharing permissions.<\/span><\/li>\n<\/ul>\n<p>&nbsp;<\/p>\n<p><span style=\"font-weight: 400;\">This tutorial demonstrated how to run fMRIPrep on a NKI subject. If you have any questions, please direct them to <\/span><a href=\"https:\/\/neurostars.org\/tags\/fmriprep\"><span style=\"font-weight: 400;\">neurostars using the fmriprep tag<\/span><\/a><span style=\"font-weight: 400;\"> and the experts will be able to help you through the issue. If you would like to contribute to fMRIPrep, please find the GitHub repository <\/span><a href=\"https:\/\/github.com\/poldracklab\/fmriprep\/tree\/master\/docs\"><span style=\"font-weight: 400;\">here<\/span><\/a><span style=\"font-weight: 400;\">.<\/span><\/p>\n","protected":false},"excerpt":{"rendered":"<p>Introduction Welcome to our tutorial on running fMRIPrep (for a more detailed description of the tool, please check out our recent paper\/preprint). In this tutorial, we will be utilizing the docker container of fMRIPrep. This tutorial will illustrate a detailed step-by-step guide on how to prepare and run this. We will provide the command line [&hellip;]<\/p>\n","protected":false},"author":4,"featured_media":0,"comment_status":"closed","ping_status":"closed","sticky":false,"template":"","format":"standard","meta":{"_exactmetrics_skip_tracking":false,"_exactmetrics_sitenote_active":false,"_exactmetrics_sitenote_note":"","_exactmetrics_sitenote_category":0,"footnotes":""},"categories":[6],"tags":[],"class_list":["post-789","post","type-post","status-publish","format-standard","hentry","category-blog"],"_links":{"self":[{"href":"https:\/\/reproducibility.stanford.edu\/wp-json\/wp\/v2\/posts\/789","targetHints":{"allow":["GET"]}}],"collection":[{"href":"https:\/\/reproducibility.stanford.edu\/wp-json\/wp\/v2\/posts"}],"about":[{"href":"https:\/\/reproducibility.stanford.edu\/wp-json\/wp\/v2\/types\/post"}],"author":[{"embeddable":true,"href":"https:\/\/reproducibility.stanford.edu\/wp-json\/wp\/v2\/users\/4"}],"replies":[{"embeddable":true,"href":"https:\/\/reproducibility.stanford.edu\/wp-json\/wp\/v2\/comments?post=789"}],"version-history":[{"count":11,"href":"https:\/\/reproducibility.stanford.edu\/wp-json\/wp\/v2\/posts\/789\/revisions"}],"predecessor-version":[{"id":913,"href":"https:\/\/reproducibility.stanford.edu\/wp-json\/wp\/v2\/posts\/789\/revisions\/913"}],"wp:attachment":[{"href":"https:\/\/reproducibility.stanford.edu\/wp-json\/wp\/v2\/media?parent=789"}],"wp:term":[{"taxonomy":"category","embeddable":true,"href":"https:\/\/reproducibility.stanford.edu\/wp-json\/wp\/v2\/categories?post=789"},{"taxonomy":"post_tag","embeddable":true,"href":"https:\/\/reproducibility.stanford.edu\/wp-json\/wp\/v2\/tags?post=789"}],"curies":[{"name":"wp","href":"https:\/\/api.w.org\/{rel}","templated":true}]}}